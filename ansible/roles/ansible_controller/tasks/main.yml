---
- name: install base deps
  ansible.builtin.apt:
    name:
      - "awscli"
      - "etckeeper"
      - "git"
      - "python3-dnspython"
      - "python3-boto3"
      - "tmux"
      - "vim"
    state: "latest"
    update_cache: "yes"

- name: set the hostname
  ansible.builtin.hostname:
    name: "ansible-controller"

- name: clone devops repo into /srv/devops
  ansible.builtin.git:
    repo: "https://github.com/ooni/devops.git"
    dest: /srv/devops

- name: Set permissions on /src/devops
  ansible.builtin.file:
    path: /srv/devops
    state: directory
    recurse: yes
    owner: ubuntu
    group: admin
    mode: "u=rw,g=rw,o=r"

- name: set global gitconfig for each user
  ansible.builtin.copy:
    content: |
      # Do not edit! ansible managed via ooni/devops
      [safe]
        directory = /srv/devops
    dest: "/home/{{ item }}/.gitconfig"
  with_items: "{{ non_admin_usernames | union(admin_usernames) }}"
